<!DOCTYPE html>
<style>
  canvas {
    width: 100%;
  }
</style>
<h1>lol</h1>
<input type="file" id="f" />
<canvas id="c1"></canvas>
<canvas id="c2"></canvas>
<script type="module">
  import factory from "./raw/build/raw.js";
  import init, { resize_u16 } from "./resize/pkg/resize.js";

  const { f, c1, c2 } = document.all;

  const m = await factory();
  await m.ready;
  await init();
  f.addEventListener("change", async (ev) => {
    if (ev.target.files.length <= 0) return;
    const buffer = await new Response(ev.target.files[0]).arrayBuffer();
    let img = m.decode(new Uint8Array(buffer));
    img = resize(img, 0.2);
    showImage(img, c2);
  });

  function showImage(img, c) {
    const imgData = toImageData(img);
    c.width = imgData.width;
    c.height = imgData.height;
    const ctx = c.getContext("2d");
    ctx.putImageData(imgData, 0, 0);
  }

  function resize(img, factor) {
    const result = resize_u16(img.data, img.width, img.height, factor, 0);
    console.log({ result });
    const [data, width, height] = result;
    return {
      ...img,
      width,
      height,
      data,
    };
  }

  function toImageData(img) {
    const imgData = new ImageData(img.width, img.height);
    for (let y = 0; y < img.height; y++) {
      for (let x = 0; x < img.width; x++) {
        imgData.data[4 * (y * img.width + x) + 0] =
          img.data[3 * (y * img.width + x) + 0] * 255;
        imgData.data[4 * (y * img.width + x) + 1] =
          img.data[3 * (y * img.width + x) + 1] * 255;
        imgData.data[4 * (y * img.width + x) + 2] =
          img.data[3 * (y * img.width + x) + 2] * 255;
        imgData.data[4 * (y * img.width + x) + 3] = 255;
      }
    }
    return imgData;
  }
</script>
